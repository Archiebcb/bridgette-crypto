<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridgette Crypto Bridge</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: url('/static/bridgette.jpg') no-repeat center center fixed;
            background-size: cover;
            background-color: #1c2526;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
            overflow-y: auto;
            filter: brightness(1.1) contrast(1.1);
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(128, 0, 128, 0.4), rgba(255, 105, 180, 0.2));
            z-index: 1;
            animation: pulse 6s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 0.6; }
            100% { opacity: 0.4; }
        }
        .navbar {
            background: linear-gradient(90deg, #1c2526, #2a3d3f);
            border-bottom: 2px solid #ff4040;
            position: relative;
            z-index: 10;
        }
        .navbar-brand {
            font-size: 2.5em;
            color: #ff69b4 !important;
            font-weight: bold;
            text-shadow: 0 0 15px #ff69b4;
            animation: glitch 2s linear infinite;
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            2% { transform: translate(-3px, 3px); }
            4% { transform: translate(3px, -3px); }
            6% { transform: translate(0); }
            100% { transform: translate(0); }
        }
        #bridge-dashboard {
            min-height: 90vh;
            padding: 30px;
            background: rgba(28, 37, 38, 0.8);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 64, 64, 0.6);
            margin-top: 60px;
            position: relative;
            z-index: 10;
            backdrop-filter: blur(8px);
            border: 2px solid #ff4040;
            animation: neon-border 4s infinite;
        }
        @keyframes neon-border {
            0% { border-color: #ff4040; box-shadow: 0 0 15px #ff4040; }
            50% { border-color: #ff69b4; box-shadow: 0 0 15px #ff69b4; }
            100% { border-color: #800080; box-shadow: 0 0 15px #800080; }
        }
        .description {
            padding: 20px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            color: #ff69b4;
            text-shadow: 0 0 10px #ff69b4;
            font-size: 1.4em;
        }
        #interactive-bridge {
            width: 100%;
            height: 450px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            border: 2px solid #ff4040;
            background: rgba(28, 37, 38, 0.5);
        }
        #bridge-message {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #ff69b4;
            text-shadow: 0 0 20px #ff69b4, 0 0 10px #800080;
            opacity: 0;
            transition: opacity 0.5s ease-in;
            z-index: 12;
        }
        .holographic {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: url('/static/hologram.png') no-repeat center;
            background-size: contain;
            background-color: rgba(255, 105, 180, 0.2);
            opacity: 0.8;
            animation: holographicPulse 4s ease-in-out infinite;
            z-index: 11;
            cursor: pointer;
        }
        @keyframes holographicPulse {
            0% { opacity: 0.8; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-15px); }
            100% { opacity: 0.8; transform: translateY(0); }
        }
        .holographic:hover::after {
            content: 'Click for Bridgette\'s Insights';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 105, 180, 0.8);
            color: #1c2526;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 12;
        }
        .chat-box {
            background: rgba(47, 68, 70, 0.8);
            border-radius: 15px;
            padding: 20px;
            min-height: 250px;
            overflow-y: auto;
            border-left: 4px solid #ff4040;
            margin-bottom: 20px;
            position: relative;
            font-size: 1.1em;
            animation: holographicChat 3s infinite;
        }
        @keyframes holographicChat {
            0% { box-shadow: 0 0 10px #ff4040; }
            50% { box-shadow: 0 0 20px #ff69b4; }
            100% { box-shadow: 0 0 10px #800080; }
        }
        .chat-box p {
            opacity: 0;
            animation: type 1s forwards;
        }
        @keyframes type {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .ticker {
            color: #ff69b4;
            font-weight: bold;
            margin-top: 15px;
            font-size: 1.3em;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        .ticker.active {
            opacity: 1;
        }
        .input-group {
            margin-top: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn-primary {
            background-color: #ff4040;
            border-color: #ff4040;
            transition: all 0.3s;
            padding: 12px 25px;
            font-size: 1.3em;
            box-shadow: 0 0 15px #ff4040;
        }
        .btn-primary:hover {
            background-color: #ff6969;
            border-color: #ff6969;
            box-shadow: 0 0 20px #ff6969;
        }
        .btn-success {
            background-color: #ff69b4;
            border-color: #ff69b4;
            transition: all 0.3s;
            padding: 10px 20px;
            font-size: 1.1em;
            box-shadow: 0 0 15px #ff69b4;
        }
        .btn-success:hover {
            background-color: #ff85a1;
            border-color: #ff85a1;
            box-shadow: 0 0 20px #ff85a1;
        }
        .btn-info {
            background-color: #800080;
            border-color: #800080;
            transition: all 0.3s;
            padding: 10px 20px;
            font-size: 1.1em;
            box-shadow: 0 0 15px #800080;
        }
        .btn-info:hover {
            background-color: #9932cc;
            border-color: #9932cc;
            box-shadow: 0 0 20px #9932cc;
        }
        .sidebar {
            background: rgba(28, 37, 38, 0.7);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 64, 64, 0.4);
            margin-bottom: 20px;
        }
        .sidebar h5 {
            color: #ff69b4;
            text-shadow: 0 0 10px #ff69b4;
            font-size: 1.5em;
        }
        .select2-container--default .select2-selection--single {
            background-color: rgba(47, 68, 70, 0.7);
            border: 2px solid #ff4040;
            color: #e0e0e0;
            height: 50px;
            border-radius: 8px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e0e0e0;
            line-height: 50px;
            padding-left: 12px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 50px;
        }
        .select2-dropdown {
            background-color: rgba(47, 68, 70, 0.7);
            border: 2px solid #ff4040;
            border-radius: 8px;
        }
        .select2-results__option {
            color: #e0e0e0;
            padding: 12px;
        }
        .select2-results__option--highlighted {
            background-color: #ff69b4 !important;
            color: #1c2526;
        }
        .history-tab {
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #ff4040;
        }
        .analytics {
            background: rgba(47, 68, 70, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #ff4040;
        }
        .alert-section {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff4040;
        }
        .suggestion-box {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff69b4;
        }
        .trend-graph {
            margin-top: 20px;
            height: 200px;
            background: rgba(47, 68, 70, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff4040;
        }
        .ar-preview {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff69b4;
            text-align: center;
        }
        .quantum-trade {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #800080;
            text-align: center;
        }
        .blockchain-tracker {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff4040;
        }
        .security-scanner {
            margin-top: 20px;
            padding: 10px;
            background: rgba(28, 37, 38, 0.7);
            border-radius: 15px;
            border-left: 4px solid #800080;
        }
        .holo-dashboard {
            margin-top: 20px;
            padding: 10px;
            background: rgba(47, 68, 70, 0.7);
            border-radius: 15px;
            border-left: 4px solid #ff69b4;
            animation: holographicDash 3s infinite;
        }
        @keyframes holographicDash {
            0% { box-shadow: 0 0 10px #ff69b4; }
            50% { box-shadow: 0 0 20px #800080; }
            100% { box-shadow: 0 0 10px #ff69b4; }
        }
        @media (max-width: 768px) {
            #bridge-dashboard { padding: 15px; }
            #interactive-bridge { height: 300px; }
            .sidebar { margin-bottom: 15px; }
            .navbar-brand { font-size: 1.8em; }
            .description { font-size: 1.2em; }
            .holographic { width: 80px; height: 80px; }
            .input-group { flex-direction: column; gap: 15px; }
            .btn-primary { font-size: 1.1em; padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Bridgette</a>
        </div>
    </nav>
    <div class="container">
        <div class="description">
            <h4>Welcome to Bridgette Crypto Bridge</h4>
            <p>Bridgette is your futuristic gateway to seamless cryptocurrency swapping. Powered by advanced AI, she connects major exchanges to provide real-time rates and secure transactions. Bridge your assets with confidence!</p>
        </div>
    </div>
    <div class="container">
        <div class="row" id="bridge-dashboard">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="sidebar">
                            <h5>Market Stats</h5>
                            <div id="market-ticker-container">
                                <p class="ticker" id="ticker-1">ETH/USDT: Loading...</p>
                                <p class="ticker" id="ticker-2">SOL/USDT: Loading...</p>
                                <p class="ticker" id="ticker-3">SRM/USDT: Loading...</p>
                                <p class="ticker" id="ticker-4">RAY/USDT: Loading...</p>
                                <p class="ticker" id="ticker-5">BTC/USDT: Loading...</p>
                                <p class="ticker" id="ticker-6">ADA/USDT: Loading...</p>
                            </div>
                        </div>
                        <div class="alert-section">
                            <h5>Price Alerts</h5>
                            <select class="form-control" id="alert-pair">
                                <option value="">Select Pair</option>
                                <option value="ETH/USDT">ETH/USDT</option>
                                <option value="SOL/USDT">SOL/USDT</option>
                                <option value="SRM/USDT">SRM/USDT</option>
                                <option value="RAY/USDT">RAY/USDT</option>
                                <option value="BTC/USDT">BTC/USDT</option>
                                <option value="ADA/USDT">ADA/USDT</option>
                            </select>
                            <input type="number" class="form-control" id="alert-price" placeholder="Alert Price" step="0.01">
                            <button class="btn btn-primary mt-2" id="setAlertButton">Set Alert</button>
                            <div id="alert-message"></div>
                        </div>
                        <div class="trend-graph">
                            <h5>Market Trends</h5>
                            <canvas id="trend-canvas"></canvas>
                        </div>
                        <div class="ar-preview">
                            <h5>AR Preview</h5>
                            <button class="btn btn-success" id="toggleARButton">Toggle AR View</button>
                            <div id="ar-container"></div>
                        </div>
                        <div class="quantum-trade">
                            <h5>Quantum Trade Generator</h5>
                            <button class="btn btn-info" id="generateTradeButton">Generate Trade</button>
                            <div id="quantum-trade-result"></div>
                        </div>
                        <div class="blockchain-tracker">
                            <h5>Blockchain Tracker</h5>
                            <p id="block-height">Block: Loading...</p>
                            <button class="btn btn-primary" id="refreshBlockButton">Refresh</button>
                        </div>
                        <div class="security-scanner">
                            <h5>Security Scanner</h5>
                            <p id="security-status">Scanning...</p>
                            <button class="btn btn-info" id="scanSecurityButton">Check Security</button>
                        </div>
                        <div class="holo-dashboard">
                            <h5>Holo Trade Dashboard</h5>
                            <p id="holo-stats">Total Bridged: 0 USD | Best Trade: 0 USD</p>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="input-group">
                            <select class="form-control chain-select" id="from-chain">
                                <option value="">From Chain</option>
                                <option value="cryptocom">Ethereum (Crypto.com)</option>
                                <option value="solana">Solana</option>
                            </select>
                            <select class="form-control token-select" id="from-token">
                                <option value="">From Token</option>
                            </select>
                            <input type="number" class="form-control" id="amount" placeholder="Amount" step="0.01" aria-label="Amount">
                            <select class="form-control chain-select" id="to-chain">
                                <option value="">To Chain</option>
                                <option value="cryptocom">Ethereum (Crypto.com)</option>
                                <option value="solana">Solana</option>
                            </select>
                            <select class="form-control token-select" id="to-token">
                                <option value="">To Token</option>
                            </select>
                            <button class="btn btn-primary" id="swapButton">Swap</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div id="interactive-bridge">
                    <div id="bridge-message"></div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="chat-box">
                    <p id="greeting">{{ greeting }}</p>
                    <p class="ticker" id="ticker">Loading rates...</p>
                </div>
            </div>
            <div class="col-md-12">
                <div class="history-tab">
                    <h5>Transaction History</h5>
                    <ul id="history-list"></ul>
                </div>
            </div>
            <div class="col-md-12">
                <div class="analytics">
                    <h5>Analytics</h5>
                    <p>Total Bridged: <span id="total-bridged">0</span> USD</p>
                    <p>Best Trade: <span id="best-trade">0</span> USD</p>
                    <div id="smart-suggestions"></div>
                </div>
                <div class="suggestion-box">
                    <h5>AI Trade Suggestions</h5>
                    <p id="ai-suggestion">Analyzing market... Check back after a swap!</p>
                </div>
            </div>
        </div>
        <div class="holographic" id="holographic"></div>
        <div id="future-bridge-space" style="height: 200px; background: rgba(28, 37, 38, 0.7); margin-top: 20px; border-radius: 15px; text-align: center; color: #ff69b4; padding: 20px;">
            <h4>Future Bridge Visualization</h4>
            <p>Coming soon: An immersive 3D bridge experience!</p>
        </div>
    </div>
    <audio id="bridge-audio" src="/static/bridge-complete.mp3" preload="auto"></audio>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js" defer></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/controls/OrbitControls.js" defer></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/loaders/TextureLoader.js" defer></script>
    <script defer>
        window.onload = function() {
            let alerts = {};
            let speechSynthesisSupported = window.speechSynthesis !== undefined;
            let arEnabled = false;
            let trendData = { labels: [], values: [] };
            let blockHeight = 0;
            let trendChart = null;

            $(document).ready(function() {
                $('.chain-select, .token-select').select2({
                    placeholder: "Select an option",
                    allowClear: true,
                    width: '100%',
                    minimumResultsForSearch: 0,
                    matcher: function(params, data) {
                        if ($.trim(params.term) === '') return data;
                        if (data.text.toUpperCase().indexOf(params.term.toUpperCase()) >= 0) return data;
                        return null;
                    }
                });
                $('#from-chain').on('change', function() { populateTokens('from-token', $(this).val()); });
                $('#to-chain').on('change', function() { populateTokens('to-token', $(this).val()); });
                $('#swapButton').on('click', requestSwap);
                $('#setAlertButton').on('click', setPriceAlert);
                $('#toggleARButton').on('click', toggleAR);
                $('#generateTradeButton').on('click', generateQuantumTrade);
                $('#refreshBlockButton').on('click', updateBlockHeight);
                $('#scanSecurityButton').on('click', scanSecurity);
                $('#holographic').on('click', speakCommand);
                initTrendGraph();
                updateBlockHeight();
                attemptTickerUpdate();
            });

            function attemptTickerUpdate(attempts = 15, delay = 2000) {
                const tickerElement = document.getElementById('ticker');
                const marketTickerContainer = document.getElementById('market-ticker-container');
                const allTickers = ['ticker-1', 'ticker-2', 'ticker-3', 'ticker-4', 'ticker-5', 'ticker-6'];
                const allElementsPresent = allTickers.every(id => document.getElementById(id));
                if (tickerElement && marketTickerContainer && allElementsPresent) {
                    console.log('Ticker elements found, starting updateTicker');
                    updateTicker();
                } else if (attempts > 0) {
                    console.log(`Ticker elements not found, retrying... (${attempts} attempts left). DOM ready: ${document.readyState}, Ticker exists: ${!!tickerElement}, Container exists: ${!!marketTickerContainer}, All tickers: ${allElementsPresent}`);
                    setTimeout(() => attemptTickerUpdate(attempts - 1, delay), delay);
                } else {
                    console.error('Ticker elements not found after all attempts, showing static message');
                    if (marketTickerContainer) {
                        marketTickerContainer.innerHTML = '<p class="ticker">Market data unavailable. Refresh to retry.</p>';
                    }
                }
            }

            function updateTicker() {
                fetch('/ticker')
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        const tickerElement = document.getElementById('ticker');
                        if (tickerElement) {
                            tickerElement.innerText = `${data.message}\n${data.rates['ETH/USDT'] || 'No rate yet!'}`;
                        } else {
                            console.error('Ticker element not found in updateTicker');
                            return;
                        }
                        const tickers = [
                            { id: 'ticker-1', pair: 'ETH/USDT' },
                            { id: 'ticker-2', pair: 'SOL/USDT' },
                            { id: 'ticker-3', pair: 'SRM/USDT' },
                            { id: 'ticker-4', pair: 'RAY/USDT' },
                            { id: 'ticker-5', pair: 'BTC/USDT' },
                            { id: 'ticker-6', pair: 'ADA/USDT' }
                        ];
                        let currentIndex = 0;
                        function cycleTickers() {
                            tickers.forEach((ticker, index) => {
                                const element = document.getElementById(ticker.id);
                                if (element) {
                                    if (index === currentIndex) {
                                        element.classList.add('active');
                                        element.innerText = `${ticker.pair}: ${data.rates[ticker.pair] || 'Loading...'}`;
                                        checkPriceAlert(ticker.pair, data.rates[ticker.pair] || 0);
                                        updateTrendData(ticker.pair, data.rates[ticker.pair] || 0);
                                    } else {
                                        element.classList.remove('active');
                                    }
                                }
                            });
                            currentIndex = (currentIndex + 1) % tickers.length;
                        }
                        cycleTickers();
                        setInterval(cycleTickers, 5000);
                        setTimeout(updateTicker, 5000);
                    })
                    .catch(error => {
                        console.error('Ticker fetch error:', error);
                        setTimeout(updateTicker, 2000);
                    });
            }

            function populateTokens(target, chain) {
                fetch('/available_pairs')
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        const select = document.getElementById(target);
                        if (!select) {
                            console.error(`Select element ${target} not found`);
                            return;
                        }
                        select.innerHTML = '<option value="">Select Token</option>';
                        if (chain && data.pairs[chain]) {
                            const uniqueTokens = new Set();
                            data.pairs[chain].forEach(pair => {
                                const [from, to] = pair.split('/');
                                uniqueTokens.add(from);
                                uniqueTokens.add(to);
                            });
                            uniqueTokens.forEach(token => {
                                const option = new Option(token, token);
                                select.add(option);
                            });
                        } else {
                            console.error('No pairs found for chain:', chain);
                        }
                        $(`#${target}`).trigger('change');
                    })
                    .catch(error => console.error('Pairs fetch error:', error));
            }

            let bridgeScene, bridgeCamera, bridgeRenderer, controls;
            let bridgeDeck;
            let bridgeProgress = 0;
            let animationFrameId;
            let isAnimating = false;
            const ANIMATION_DURATION = 3000;
            let animationStartTime = null;
            const audio = document.getElementById('bridge-audio');
            let bridgeInitialized = false;

            function initBridge() {
                const container = document.getElementById('interactive-bridge');
                if (!container) {
                    console.error('Interactive bridge container not found');
                    container.innerHTML = '<p style="color: #ff4040;">Bridge container not found. Please check the page structure.</p>';
                    return;
                }

                bridgeCamera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                bridgeCamera.position.set(0, 5, 15);
                bridgeCamera.lookAt(0, 0, 0);
                bridgeScene = new THREE.Scene();
                bridgeScene.background = new THREE.Color(0x1c2526);
                bridgeRenderer = new THREE.WebGLRenderer({ antialias: true });
                bridgeRenderer.setSize(container.offsetWidth, container.offsetHeight);
                container.appendChild(bridgeRenderer.domElement);
                controls = new THREE.OrbitControls(bridgeCamera, bridgeRenderer.domElement);

                const ambientLight = new THREE.AmbientLight(0x404040);
                bridgeScene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(0, 10, 10);
                bridgeScene.add(directionalLight);

                const deckMaterial = new THREE.MeshPhongMaterial({ color: 0xff4040, emissive: 0xff4040, emissiveIntensity: 0.3 });
                const deckGeometry = new THREE.BoxGeometry(14, 0.4, 2.5);
                bridgeDeck = new THREE.Mesh(deckGeometry, deckMaterial);
                bridgeDeck.position.y = 0.6;
                bridgeDeck.scale.x = 0;
                bridgeScene.add(bridgeDeck);

                bridgeRenderer.render(bridgeScene, bridgeCamera);
                console.log('Bridge canvas size:', container.offsetWidth, 'x', container.offsetHeight);
                console.log('Bridge initialized successfully, rendering initial frame');

                bridgeInitialized = true;
                animateBridge();

                window.addEventListener('resize', () => {
                    bridgeCamera.aspect = container.offsetWidth / container.offsetHeight;
                    bridgeCamera.updateProjectionMatrix();
                    bridgeRenderer.setSize(container.offsetWidth, container.offsetHeight);
                    bridgeRenderer.render(bridgeScene, bridgeCamera);
                });
                if (audio) audio.load();
            }

            function animateBridge(time) {
                if (!bridgeInitialized || !bridgeRenderer || !bridgeScene || !bridgeCamera) {
                    console.error('Rendering failed: Missing bridgeRenderer, bridgeScene, or bridgeCamera');
                    return;
                }
                animationFrameId = requestAnimationFrame(animateBridge);
                if (isAnimating) {
                    if (!animationStartTime) animationStartTime = time;
                    const elapsed = time - animationStartTime;
                    bridgeProgress = Math.min(elapsed / ANIMATION_DURATION, 1);
                    if (bridgeDeck) bridgeDeck.scale.x = bridgeProgress * 1.2;
                    if (bridgeProgress >= 1) {
                        isAnimating = false;
                        stopBridgeAnimation();
                        if (speechSynthesisSupported) speakCommand();
                    }
                }
                bridgeRenderer.render(bridgeScene, bridgeCamera);
                if (controls) controls.update();
            }

            function startBridgeAnimation() {
                if (!bridgeInitialized) {
                    console.error('Bridge not initialized, cannot start animation');
                    return;
                }
                bridgeProgress = 0;
                if (bridgeDeck) bridgeDeck.scale.x = 0;
                isAnimating = true;
                animationStartTime = null;
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(error => console.log('Audio play failed due to autoplay:', error));
                }
                const message = document.getElementById('bridge-message');
                if (message) message.style.opacity = 0;
            }

            function stopBridgeAnimation() {
                const message = document.getElementById('bridge-message');
                if (message) {
                    message.textContent = 'Your bridge has been built!';
                    message.style.opacity = 1;
                }
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }

            function requestSwap() {
                const fromChain = document.getElementById('from-chain')?.value;
                const fromToken = document.getElementById('from-token')?.value;
                const amount = document.getElementById('amount')?.value;
                const toChain = document.getElementById('to-chain')?.value;
                const toToken = document.getElementById('to-token')?.value;

                if (!fromChain || !fromToken || !amount || !toChain || !toToken) {
                    alert('Please fill in all fields!');
                    return;
                }

                startBridgeAnimation();
                scanSecurity();

                fetch('/simulate_swap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_chain: fromChain, from_token: fromToken, amount: parseFloat(amount), to_chain: toChain, to_token: toToken })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                    return response.json();
                })
                .then(data => {
                    const chat = document.querySelector('.chat-box');
                    if (chat) {
                        chat.innerHTML = '<p id="greeting">{{ greeting }}</p>';
                        if (data.error) {
                            chat.innerHTML += `<p style="color: #ff4040;">Error: ${data.error}</p>`;
                        } else {
                            chat.innerHTML += `<p>You would receive: ${data.quote.toFixed(2)} ${toToken}</p>`;
                            updateAISuggestion(fromToken, toToken, amount, data.quote);
                            updateHoloDashboard(data.total_bridged || 0, data.best_trade || 0);
                        }
                        chat.scrollTop = chat.scrollHeight;
                    }
                    updateHistory();
                    updateAnalytics();
                })
                .catch(error => {
                    console.error('Swap error:', error);
                    const chat = document.querySelector('.chat-box');
                    if (chat) {
                        chat.innerHTML = '<p id="greeting">{{ greeting }}</p>';
                        chat.innerHTML += `<p style="color: #ff4040;">Error: Failed to fetch swap quote. Please try again later.</p>`;
                        chat.scrollTop = chat.scrollHeight;
                    }
                    updateHistory();
                    updateAnalytics();
                });
            }

            function updateHistory() {
                const list = document.getElementById('history-list');
                if (!list) {
                    console.error('History list not found');
                    return;
                }
                fetch('/history')
                    .then(response => response.json())
                    .then(data => {
                        list.innerHTML = '';
                        data.history.forEach(item => {
                            list.innerHTML += `<li>${item.timestamp} - ${item.amount} ${item.from_token} (${item.from_chain}) to ${item.to_token} (${item.to_chain}) = ${item.quote.toFixed(2)} ${item.to_token} ${item.error ? `(Error: ${item.error})` : ''}</li>`;
                        });
                    })
                    .catch(error => console.error('History fetch error:', error));
            }

            function updateAnalytics() {
                const totalBridgedSpan = document.getElementById('total-bridged');
                const bestTradeSpan = document.getElementById('best-trade');
                const suggestionsDiv = document.getElementById('smart-suggestions');
                if (!totalBridgedSpan || !bestTradeSpan || !suggestionsDiv) {
                    console.error('Analytics elements not found');
                    return;
                }
                fetch('/analytics')
                    .then(response => response.json())
                    .then(data => {
                        totalBridgedSpan.innerText = data.total_bridged.toFixed(2) || 0;
                        bestTradeSpan.innerText = data.best_trade.toFixed(2) || 0;
                        if (data.best_trade > 0) {
                            suggestionsDiv.innerText = 'Suggestion: Repeat your best trade pair for max profit!';
                        } else {
                            suggestionsDiv.innerText = '';
                        }
                        updateHoloDashboard(data.total_bridged || 0, data.best_trade || 0);
                    })
                    .catch(error => console.error('Analytics fetch error:', error));
            }

            function setPriceAlert() {
                const pair = document.getElementById('alert-pair')?.value;
                const price = document.getElementById('alert-price')?.value;
                const messageDiv = document.getElementById('alert-message');
                if (messageDiv && pair && price) {
                    alerts[pair] = parseFloat(price);
                    messageDiv.innerText = `Alert set for ${pair} at $${price}`;
                    setTimeout(() => messageDiv.innerText = '', 5000);
                } else if (messageDiv) {
                    messageDiv.innerText = 'Please select a pair and enter a price';
                    setTimeout(() => messageDiv.innerText = '', 5000);
                }
            }

            function checkPriceAlert(pair, currentPrice) {
                if (alerts[pair] && currentPrice >= alerts[pair]) {
                    const messageDiv = document.getElementById('alert-message');
                    if (messageDiv) {
                        messageDiv.innerText = `Alert: ${pair} reached $${currentPrice}!`;
                        if (speechSynthesisSupported) {
                            speak(`Alert: ${pair} has reached ${currentPrice} dollars.`);
                        }
                        delete alerts[pair];
                        setTimeout(() => messageDiv.innerText = '', 5000);
                    }
                }
            }

            function updateAISuggestion(fromToken, toToken, amount, quote) {
                const suggestionP = document.getElementById('ai-suggestion');
                if (suggestionP) {
                    const profitMargin = (quote - amount) / amount * 100;
                    let suggestion = `No suggestion yet.`;
                    if (profitMargin > 5) {
                        suggestion = `Great trade! Consider swapping more ${fromToken} to ${toToken} for a ${profitMargin.toFixed(2)}% profit!`;
                    } else if (profitMargin < -5) {
                        suggestion = `Caution: This trade lost ${(-profitMargin).toFixed(2)}%. Try a different pair.`;
                    }
                    suggestionP.innerText = suggestion;
                }
            }

            function speakCommand() {
                if (speechSynthesisSupported) {
                    const commands = ['show history', 'show analytics', 'repeat greeting'];
                    const command = commands[Math.floor(Math.random() * commands.length)];
                    let utterance;
                    switch(command) {
                        case 'show history':
                            utterance = new SpeechSynthesisUtterance('Showing transaction history.');
                            updateHistory();
                            break;
                        case 'show analytics':
                            utterance = new SpeechSynthesisUtterance('Showing analytics.');
                            updateAnalytics();
                            break;
                        case 'repeat greeting':
                            const greeting = document.getElementById('greeting');
                            utterance = new SpeechSynthesisUtterance(greeting ? greeting.innerText : '');
                            break;
                    }
                    if (utterance) {
                        utterance.volume = 1;
                        utterance.rate = 1;
                        utterance.pitch = 1;
                        window.speechSynthesis.speak(utterance);
                    }
                } else {
                    console.log('Speech synthesis not supported in this browser.');
                }
            }

            function initTrendGraph() {
                const canvas = document.getElementById('trend-canvas');
                if (!canvas) {
                    console.error('Trend canvas not found');
                    return;
                }
                trendChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: 'Price Trend (USDT)',
                            data: trendData.values,
                            borderColor: '#ff69b4',
                            fill: false
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: false } },
                        animation: false
                    }
                });
            }

            function updateTrendData(pair, price) {
                trendData.labels.push(new Date().toLocaleTimeString());
                trendData.values.push(price);
                if (trendData.labels.length > 10) {
                    trendData.labels.shift();
                    trendData.values.shift();
                }
                if (trendChart) {
                    trendChart.data.labels = trendData.labels;
                    trendChart.data.datasets[0].data = trendData.values;
                    trendChart.update();
                } else {
                    console.error('Trend chart not initialized');
                }
            }

            function toggleAR() {
                const container = document.getElementById('ar-container');
                if (!container) {
                    console.error('AR container not found');
                    return;
                }
                if (!arEnabled) {
                    container.innerHTML = '<p>AR view enabled. Point your device at a flat surface.</p>';
                    arEnabled = true;
                } else {
                    container.innerHTML = '';
                    arEnabled = false;
                }
            }

            function generateQuantumTrade() {
                const chains = ['cryptocom', 'solana'];
                const tokens = ['ETH', 'SOL', 'SRM', 'RAY', 'BTC', 'ADA', 'XRP'];
                const fromChain = chains[Math.floor(Math.random() * chains.length)];
                const toChain = chains[Math.floor(Math.random() * chains.length)];
                const fromToken = tokens[Math.floor(Math.random() * tokens.length)];
                const toToken = tokens[Math.floor(Math.random() * tokens.length)];
                const amount = (Math.random() * 10 + 1).toFixed(2);
                const resultDiv = document.getElementById('quantum-trade-result');
                if (resultDiv) {
                    resultDiv.innerText = `Quantum Suggestion: Swap ${amount} ${fromToken} from ${fromChain} to ${toToken} on ${toChain}`;
                }
            }

            function updateBlockHeight() {
                const blockHeightP = document.getElementById('block-height');
                if (blockHeightP) {
                    blockHeight = Math.floor(Math.random() * 1000000) + 1;
                    blockHeightP.innerText = `Block: ${blockHeight}`;
                    setTimeout(updateBlockHeight, 10000);
                }
            }

            function scanSecurity() {
                const statusP = document.getElementById('security-status');
                if (statusP) {
                    const status = Math.random() > 0.1 ? 'Secure' : 'Warning: Potential Issue Detected';
                    statusP.innerText = status;
                    if (status.includes('Warning') && speechSynthesisSupported) {
                        speak('Warning: Potential security issue detected. Please review.');
                    }
                    setTimeout(() => statusP.innerText = 'Scanning...', 5000);
                }
            }

            function updateHoloDashboard(totalBridged, bestTrade) {
                const holoStatsP = document.getElementById('holo-stats');
                if (holoStatsP) {
                    holoStatsP.innerText = `Total Bridged: ${totalBridged.toFixed(2)} USD | Best Trade: ${bestTrade.toFixed(2)} USD`;
                }
            }

            initBridge();
            updateHistory();
            updateAnalytics();
            setInterval(updateHistory, 5000);
            setInterval(updateAnalytics, 5000);
        };
    </script>
</body>
</html>